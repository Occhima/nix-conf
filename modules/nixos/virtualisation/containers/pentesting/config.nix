# NOTE: This entire config was  stolen from https://github.com/redcode-labs/RedNix
# I just need to addapt some stuff to my config
{
  lib,
  config,
  pkgs,
  ...
}:
let
  inherit (lib)
    mkIf
    types
    mkEnableOption
    mkOption
    ;
  cfg = config.modules.virtualisation.containers.pentesting;

in

{

  options.modules.virtualisation.containers.pentesting = {
    enable = mkEnableOption "Pentesting container environment";
    profiles = mkOption {
      type = types.listOf types.str;
      default = [
        "general"
        # "databases"
        # "exploits"
        # "git"
        "port-scanners"
        "web"
      ];
      description = "List of pentesting profiles to enable in the container";
      example = [
        "general"
        "web"
        "network"
        "forensics"
        "exploit"
      ];
    };
  };
  config = mkIf cfg.enable {
    containers.pentesting = {
      autoStart = true;
      privateNetwork = false;

      forwardPorts = [
        {
          containerPort = 22;
          hostPort = 2222;
          protocol = "tcp";
        }
        {
          containerPort = 80;
          hostPort = 8080;
          protocol = "tcp";
        }
      ];

      config =
        { config, ... }:
        {
          boot.isContainer = true;
          environment.shells = with pkgs; [ nushell ];

          environment = {
            sessionVariables = {
              DISLPLAY = "0.0.0.0:0";
              ZELLIJ_CONFIG_DIR = "/etc/xdg/zellij";
            };
            systemPackages =
              let
                pkgSets = import ./packages/pentest-pkgs.nix { inherit pkgs; };
                enabledPkgSets = builtins.filter (name: builtins.elem name cfg.profiles) (
                  builtins.attrNames pkgSets
                );
                selectedPackages = builtins.concatLists (builtins.map (name: pkgSets.${name}) enabledPkgSets);
              in
              selectedPackages;
          };

          networking = {
            nat = {
              enable = false;
              internalInterfaces = [ "ve-rednix" ];
              externalInterface = "eth0";
            };
            useDHCP = false;
            hostName = "RedNix";
            firewall = {
              enable = true;
              allowPing = true;
              allowedTCPPorts = [ ];
            };
          };

          # nix config
          nix = {
            settings.extra-experimental-features = [
              "nix-command"
              "flakes"
            ];
          };

          # nixpkgs config
          nixpkgs.config = {
            allowUnfree = true;
            allowInsecurePredicate = _p: true;
            segger-jlink.acceptLicense = true;
          };

          # services
          services = {
            getty.autologinUser = "rednix";

            openssh = {
              enable = true;
              settings.X11Forwarding = true;
            };

            avahi = {
              enable = true;
              browseDomains = [ ];
              wideArea = false;
              nssmdns4 = true;
            };

            unbound = {
              enable = true;
              settings.server = { };
            };
          };

          system.stateVersion = "25.05";

          # Zellij config via KDL (NixOS doesn't have programs.zellij)
          environment.etc."xdg/zellij/config.kdl".text = ''
            theme "polykai"
            simplified_ui true
            pane_frames true
            copy_command "wl-copy"
            copy_on_select false
            scroll_buffer_size 10000
            mouse_mode true
            session_serialization false
            mirror_session false
            on_force_close "detach"

            ui {
              pane_frames {
                rounded_corners true
                hide_session_name false
              }
            }

            themes {
              polykai {
                fg 248 248 248
                bg 20 24 24
                black 30 36 36
                red 255 176 0
                green 160 255 32
                yellow 255 224 128
                blue 96 128 255
                magenta 255 0 96
                cyan 64 196 255
                white 248 248 248
                orange 255 176 0
              }
            }
          '';

          # users
          users.users.rednix = {
            isNormalUser = true;
            uid = 1000;
            shell = pkgs.nushell;
            description = "RedNix container user";
            initialPassword = "changeme";
            extraGroups = [ "wheel" ];
          };
        };
    };

  };
}
